---
apiVersion: package.appvia.io/v2beta2
kind: Package
metadata:
  name: external-dns-azure-private
  annotations:
    appvia.io/displayName: "External DNS for Azure (Private)"
spec:
  version: "1.18.0-1"
  installNamespace: external-dns-private
  description: External DNS for Azure allows Kubernetes to manage DNS zones on Azure Private DNS

  helm:
    releaseName: external-dns-azure-private
    helmTimeout: 300s
    repositoryRef: external-dns
    chartName: external-dns
    chartVersion: "1.18.0"
    valuesTemplate: |
      domainFilters:
      {{- range .Cluster.DNSZones }}
      {{- if .Private }}
      - {{ .Domain }}
      {{- end }}
      {{- end }}
      fullnameOverride: external-dns-private
      logFormat: json
      policy: sync
      txtOwnerId: {{ .Cluster.Name }}
      serviceMonitor:
        enabled: false
      resources:
        limits:
          memory: 50Mi
        requests:
          cpu: 10m
          memory: 50Mi
      serviceAccount:
        create: true
        name: {{ .Package.WorkloadIdentity.ServiceAccountName }}
        annotations:
      {{ .Package.WorkloadIdentity.ServiceAccountAnnotations | toYaml | indent 4 }}
      podLabels:
      {{ .Package.WorkloadIdentity.PodLabels | toYaml | indent 2 }}
      {{- $resGrp := "" }}
      {{- range .Cluster.DNSZones }}
        {{- if .Private }}
          {{- $resGrp = .Azure.ResourceGroup }}
        {{- end }}
      {{- end }}
      {{- if $resGrp }}
      provider:
        name: azure-private-dns
      env:
      - name: AZURE_TENANT_ID
        value: {{ .CloudAccessConfig.Azure.Tenant }}
      - name: AZURE_SUBSCRIPTION_ID
        value: {{ .CloudAccessConfig.Azure.Subscription }}
      - name: AZURE_USE_WORKLOAD_IDENTITY_EXTENSION
        value: "true"
      - name: AZURE_RESOURCE_GROUP
        value: {{ $resGrp }}
      extraArgs:
      - --azure-resource-group={{ $resGrp }}
      {{- end }}

  workloadIdentity:
    serviceAccountName: external-dns
    role:
      azure:
        roleAssignmentsTemplate: |
          # must always have a valid role for the workload identity to work
          - scope: /subscriptions/{{ .CloudAccessConfig.Azure.Subscription }}
            roleDefinitionName: Reader
          {{- if .Cluster.DNSZones }}
            {{- range .Cluster.DNSZones }}
              {{- if .Private }}
          - scope: {{ .ZoneID }}
            roleDefinitionName: Contributor
              {{- end }}
            {{- end }}
          {{- end }}
